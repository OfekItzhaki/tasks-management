# Requirements Document

## Introduction

This document specifies the requirements for implementing Cloudflare Turnstile CAPTCHA protection on the login and registration forms of the Horizon Flux application. Cloudflare Turnstile is a privacy-focused, user-friendly CAPTCHA alternative that protects against automated attacks while minimizing friction for legitimate users.

The implementation will protect authentication endpoints from credential stuffing attacks, spam registrations, and bot abuse by requiring CAPTCHA verification before allowing login or registration attempts.

## Glossary

- **Turnstile**: Cloudflare's CAPTCHA service that validates user authenticity
- **Site_Key**: Public key used by the frontend to render the Turnstile widget
- **Secret_Key**: Private key used by the backend to verify Turnstile tokens
- **CAPTCHA_Token**: A single-use token generated by Turnstile after user validation
- **Web_Frontend**: React + Vite application (web-app/)
- **Backend_API**: NestJS application (todo-backend/)
- **Frontend_Services**: Shared service layer for API communication
- **Auth_Service**: Backend service handling authentication logic
- **Auth_Controller**: Backend controller exposing authentication endpoints
- **Login_Page**: React component for user login and registration flows
- **Turnstile_Widget**: React component that renders the Cloudflare Turnstile challenge

## Requirements

### Requirement 1: Frontend Turnstile Integration

**User Story:** As a developer, I want to integrate the Turnstile widget into the web frontend, so that users can complete CAPTCHA challenges during authentication.

#### Acceptance Criteria

1. WHEN the Login_Page renders, THE Turnstile_Widget SHALL be initialized with the Site_Key from environment variables
2. WHEN a user submits the login form, THE Web_Frontend SHALL include the CAPTCHA_Token in the login request
3. WHEN a user submits the registration form, THE Web_Frontend SHALL include the CAPTCHA_Token in the registration request
4. WHEN a user submits the forgot password form, THE Web_Frontend SHALL include the CAPTCHA_Token in the forgot password request
5. WHEN the Turnstile_Widget generates a token, THE Web_Frontend SHALL store it for submission
6. WHERE the Turnstile service is unavailable, THE Web_Frontend SHALL display an appropriate error message to the user

### Requirement 2: Backend Token Verification

**User Story:** As a system administrator, I want the backend to verify Turnstile tokens, so that only legitimate requests are processed.

#### Acceptance Criteria

1. WHEN a login request is received with a CAPTCHA_Token, THE Auth_Service SHALL verify the token with Cloudflare's API before validating credentials
2. WHEN a registration request is received with a CAPTCHA_Token, THE Auth_Service SHALL verify the token with Cloudflare's API before creating the user
3. WHEN a forgot password request is received with a CAPTCHA_Token, THE Auth_Service SHALL verify the token with Cloudflare's API before sending the reset OTP
4. IF token verification fails, THEN THE Backend_API SHALL return a 403 Forbidden error with message "CAPTCHA verification failed"
5. WHEN the Secret_Key is not configured, THE Auth_Service SHALL log a warning and skip verification
6. WHEN Cloudflare's API returns an error, THE Auth_Service SHALL log the error and return a 403 Forbidden error

### Requirement 3: Configuration Management

**User Story:** As a developer, I want to configure Turnstile keys through environment variables, so that different keys can be used for development and production.

#### Acceptance Criteria

1. THE Backend_API SHALL read the Secret_Key from the TURNSTILE_SECRET_KEY environment variable
2. THE Web_Frontend SHALL read the Site_Key from the VITE_TURNSTILE_SITE_KEY environment variable
3. WHEN the Secret_Key is not set, THE Backend_API SHALL allow requests without CAPTCHA verification
4. WHEN the Site_Key is not set, THE Web_Frontend SHALL display an error message indicating CAPTCHA is not configured
5. THE .env.example files SHALL document the required environment variables with instructions for obtaining keys

### Requirement 4: Frontend Services Integration

**User Story:** As a developer, I want the Frontend_Services layer to support CAPTCHA tokens, so that all frontends can use the same authentication interface.

#### Acceptance Criteria

1. THE Frontend_Services login method SHALL accept an optional captchaToken parameter
2. THE Frontend_Services registerStart method SHALL accept an optional captchaToken parameter
3. THE Frontend_Services forgotPassword method SHALL accept an optional captchaToken parameter
4. WHEN a captchaToken is provided, THE Frontend_Services SHALL include it in the API request payload
5. THE LoginDto type SHALL include an optional captchaToken field
6. THE RegisterStartDto type SHALL include an optional captchaToken field
7. THE ForgotPasswordDto type SHALL include an optional captchaToken field

### Requirement 5: Error Handling and User Feedback

**User Story:** As a user, I want clear error messages when CAPTCHA verification fails, so that I understand what went wrong and can retry.

#### Acceptance Criteria

1. WHEN CAPTCHA verification fails, THE Web_Frontend SHALL display an error message "CAPTCHA verification failed. Please try again."
2. WHEN the Turnstile_Widget fails to load, THE Web_Frontend SHALL display an error message "Unable to load security verification. Please refresh the page."
3. WHEN a CAPTCHA_Token is required but not provided, THE Backend_API SHALL return a 400 Bad Request error with message "CAPTCHA token required"
4. WHEN the user submits a form without completing the CAPTCHA, THE Web_Frontend SHALL prevent submission and display a validation message
5. WHEN CAPTCHA verification succeeds but authentication fails, THE Web_Frontend SHALL reset the Turnstile_Widget for a new attempt

### Requirement 6: Invisible CAPTCHA Mode

**User Story:** As a user, I want minimal friction during login and registration, so that I can access my account quickly without unnecessary challenges.

#### Acceptance Criteria

1. THE Turnstile_Widget SHALL be configured in "invisible" or "managed" mode to minimize user interaction
2. WHEN the Turnstile service determines the user is legitimate, THE CAPTCHA_Token SHALL be generated automatically without user interaction
3. WHEN the Turnstile service requires additional verification, THE Turnstile_Widget SHALL display an appropriate challenge
4. THE Turnstile_Widget SHALL complete verification before the form submission is allowed
5. THE Web_Frontend SHALL provide visual feedback during CAPTCHA verification

### Requirement 7: Mobile Application Considerations

**User Story:** As a mobile app developer, I want to understand the approach for implementing Turnstile in React Native, so that I can plan the mobile implementation.

#### Acceptance Criteria

1. THE implementation documentation SHALL note that Turnstile has limited React Native support
2. THE implementation documentation SHALL recommend using a WebView approach for mobile CAPTCHA
3. THE Backend_API SHALL accept CAPTCHA tokens from both web and mobile clients using the same verification endpoint
4. WHERE mobile implementation is deferred, THE Backend_API SHALL allow mobile clients to authenticate without CAPTCHA when Secret_Key is not set
5. THE mobile implementation strategy SHALL be documented for future development

### Requirement 8: Testing and Validation

**User Story:** As a developer, I want to test the CAPTCHA implementation in development, so that I can verify it works correctly before deploying to production.

#### Acceptance Criteria

1. THE implementation SHALL support Cloudflare's test Site_Key for development testing
2. WHEN using the test Site_Key, THE Turnstile_Widget SHALL always pass verification
3. THE Backend_API SHALL successfully verify tokens generated with the test Site_Key
4. THE implementation documentation SHALL include instructions for testing with the test Site_Key
5. THE implementation SHALL work correctly with production keys when deployed

### Requirement 9: Security Best Practices

**User Story:** As a security engineer, I want the CAPTCHA implementation to follow security best practices, so that it effectively protects against attacks.

#### Acceptance Criteria

1. THE Backend_API SHALL never expose the Secret_Key to the frontend
2. THE CAPTCHA_Token SHALL be single-use and validated only once
3. THE Backend_API SHALL verify tokens server-side and never trust client-side validation
4. THE Backend_API SHALL use HTTPS when communicating with Cloudflare's verification API
5. THE implementation SHALL log failed verification attempts for security monitoring

### Requirement 10: Graceful Degradation

**User Story:** As a system administrator, I want the application to handle Turnstile service outages gracefully, so that users can still access the application during temporary issues.

#### Acceptance Criteria

1. WHEN Cloudflare's Turnstile API is unreachable, THE Backend_API SHALL log the error and return a 403 error
2. WHEN the Turnstile_Widget fails to load after 10 seconds, THE Web_Frontend SHALL display a timeout error message
3. WHEN CAPTCHA verification fails due to network issues, THE Web_Frontend SHALL allow the user to retry
4. THE Backend_API SHALL implement a timeout of 5 seconds for Turnstile verification requests
5. WHERE the Secret_Key is not configured, THE Backend_API SHALL allow authentication without CAPTCHA verification
