name: CI

on:
  push:
    branches:
      - main
      - master
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: todo-backend
    env:
      # Ensure DATABASE_URL is set in your repository secrets
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      # You can add additional environment variables here if needed
      # Example:
      # NODE_ENV: test
    steps:
    - uses: actions/checkout@v3
    
      # Fail early if DATABASE_URL is not set
    - name: Check DATABASE_URL
      run: |
        if [ -z "${{ secrets.DATABASE_URL }}" ]; then
          echo "DATABASE_URL is not set in repository secrets."
          exit 1
        else
          echo "DATABASE_URL is configured."
        fi

    - name: Use Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 18

    - name: Install dependencies
      run: npm install

    - name: Cache node modules
      uses: actions/cache@v3
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
      
    - name: Notify Slack on failure
      if: failure()
      uses: slackapi/slack-github-action@v1.23.0
      with:
        payload: |
          {
            "text": "‚ùå CI pipeline failed for ${{ github.repository }} on ${{ github.ref }}"
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

    - name: Run ESLint
      run: npx eslint .

    - name: Build project
      run: npm run build

    - name: Run Prisma migrations
      run: npx prisma migrate deploy
      continue-on-error: true

    - name: Generate Prisma client
      run: npx prisma generate

    - name: Run tests
      run: npm test
