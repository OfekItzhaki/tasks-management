name: EAS Build Version Bump

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        default: 'patch'
      build_profile:
        description: 'EAS build profile'
        required: true
        type: choice
        options:
          - preview
          - production
        default: 'preview'

permissions:
  contents: write

jobs:
  bump-and-build:
    name: Bump Version and Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump Mobile App Version
        working-directory: mobile-app
        run: |
          # Read current version
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "Current version: $CURRENT_VERSION"

          # Bump version based on type
          if [ "${{ github.event.inputs.version_type }}" == "patch" ]; then
            NEW_VERSION=$(npm version patch --no-git-tag)
          elif [ "${{ github.event.inputs.version_type }}" == "minor" ]; then
            NEW_VERSION=$(npm version minor --no-git-tag)
          elif [ "${{ github.event.inputs.version_type }}" == "major" ]; then
            NEW_VERSION=$(npm version major --no-git-tag)
          fi

          # Remove 'v' prefix if present
          NEW_VERSION=${NEW_VERSION#v}
          echo "New version: $NEW_VERSION"

          # Update app.json version
          node -e "
            const fs = require('fs');
            const appJson = JSON.parse(fs.readFileSync('app.json', 'utf8'));
            appJson.expo.version = '$NEW_VERSION';
            if (appJson.expo.android) {
              appJson.expo.android.versionCode = (appJson.expo.android.versionCode || 0) + 1;
            }
            fs.writeFileSync('app.json', JSON.stringify(appJson, null, 2) + '\n');
          "

          echo "VERSION=$NEW_VERSION" >> $GITHUB_ENV

      - name: Commit version bump
        id: commit
        run: |
          git add mobile-app/package.json mobile-app/app.json
          NEW_VERSION=$(node -p "require('./mobile-app/package.json').version")
          git commit -m "chore: bump mobile app version to $NEW_VERSION (${{ github.event.inputs.version_type }})" || exit 0
          git push origin develop
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Build with EAS
        working-directory: mobile-app
        run: |
          eas build --profile ${{ github.event.inputs.build_profile }} --platform android --non-interactive
